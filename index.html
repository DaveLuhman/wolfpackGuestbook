<!DOCTYPE html>
<html>

<head>
  <title>Guestbook</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body>
  <img src="img/icon-256.ico" alt="Icon" class="icon" id="logo-link" />
  <h1>Guestbook</h1>
  <div id="entry-data">
    <p>Swipe or scan your Onecard to check in...</p>
  </div>
  <div id="loading-indicator" class="loading" style="display: none;">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <!-- HID Bindings Modal -->
  <div id="hid-bindings-modal" class="modal">
    <div class="modal-content">
      <h2>HID Device Bindings</h2>
      <div class="form-group">
        <label for="msrSelect">Magnetic Stripe Reader:</label>
        <select id="msrSelect" class="form-control">
          <option value="">Select a device...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="barcodeSelect">Barcode Scanner:</label>
        <select id="barcodeSelect" class="form-control">
          <option value="">Select a device...</option>
        </select>
      </div>
      <div class="button-container">
        <button id="submit-hid" class="btn btn-primary">Save</button>
        <button id="cancel-hid" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require("electron");
    const HIDManager = require('./HIDManager');
    const configManager = require('./configManager');

    // Add event listener for logo click
    document.getElementById('logo-link').addEventListener('click', () => {
      ipcRenderer.send('open-viewer-window');
    });

    function showLoading() {
      document.getElementById('loading-indicator').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading-indicator').style.display = 'none';
    }

    function showError(message) {
      const entryData = document.getElementById("entry-data");
      const body = document.body;

      body.style.backgroundColor = "red";
      entryData.innerHTML = `
        <div class="error-container">
          <div class="error-icon">⚠️</div>
          <p class="error-message">${message}</p>
          <p id="countdown" class="countdown">Clearing in 5 seconds...</p>
        </div>
      `;

      let countdown = 5;
      const countdownElement = document.getElementById("countdown");

      const interval = setInterval(() => {
        countdown--;
        countdownElement.textContent = `Clearing in ${countdown} seconds...`;
        if (countdown <= 0) {
          clearInterval(interval);
          resetScreen();
        }
      }, 1000);
    }

    function resetScreen() {
      const entryData = document.getElementById("entry-data");
      const body = document.body;

      body.style.backgroundColor = "";
      entryData.innerHTML = "<p>Swipe or scan your Onecard to check in...</p>";
    }

    // Initialize HID manager with saved device if exists
    const savedMSR = configManager.getSelectedDevice('msr');
    if (savedMSR) {
      showLoading();
      HIDManager.setDevice(savedMSR, 'msr')
        .catch(error => {
          console.error('Error initializing saved MSR device:', error);
          showError('Failed to initialize saved device');
        })
        .finally(() => hideLoading());
    }

    // Handle HID data
    const handleData = (data) => {
      showLoading();
      try {
        // Validate and process the data
        let processedData = null;
        
        if (typeof data === 'object' && data !== null) {
          if (typeof data.onecard === 'number') {
            processedData = { onecard: data.onecard, name: data.name || null };
          } else if (typeof data.onecard === 'string') {
            // Remove any non-numeric characters and convert to number
            const numericValue = parseInt(data.onecard.replace(/\D/g, ''), 10);
            if (!isNaN(numericValue)) {
              processedData = { onecard: numericValue, name: data.name || null };
            } else {
              throw new Error('Invalid data: non-numeric onecard value');
            }
          } else {
            throw new Error('Invalid data format');
          }
        } else if (typeof data === 'string') {
          // Remove any non-numeric characters and convert to number
          const numericValue = parseInt(data.replace(/\D/g, ''), 10);
          if (!isNaN(numericValue)) {
            processedData = { onecard: numericValue, name: null };
          } else {
            throw new Error('Invalid data: non-numeric value');
          }
        } else if (typeof data === 'number') {
          processedData = { onecard: data, name: null };
        } else {
          throw new Error('Invalid data format');
        }

        // Final validation
        if (!processedData || typeof processedData.onecard !== 'number' || isNaN(processedData.onecard)) {
          throw new Error('Invalid data: missing or invalid onecard number');
        }

        // Ensure name is either a string or null
        if (processedData.name !== null && typeof processedData.name !== 'string') {
          processedData.name = null;
        }

        console.log('Sending processed data:', processedData);
        ipcRenderer.send('manual-entry-submit', processedData);
      } catch (error) {
        console.error('Error processing data:', error);
        showError(error.message);
        hideLoading();
      }
    };

    // Handle HID errors
    const handleError = (error) => {
      showError(error.message);
    };

    // Register event handlers with HIDManager
    HIDManager.on('data', handleData);
    HIDManager.on('error', handleError);

    // Handle successful entry
    const handleGuestEntry = (event, data) => {
      const entryData = document.getElementById("entry-data");
      const body = document.body;

      body.style.backgroundColor = "green";
      entryData.innerHTML = `
        <p><strong>Name:</strong> ${data.name}</p>
        <div class="entry-row">
          <div class="entry-field">
            <strong>Entry Time:</strong> <br />${new Date().toLocaleString()}
          </div>
        </div>
        <p id="countdown">Clearing in 5 seconds...</p>
      `;

      let countdown = 5;
      const countdownElement = document.getElementById("countdown");

      const interval = setInterval(() => {
        countdown--;
        countdownElement.textContent = `Clearing in ${countdown} seconds...`;
        if (countdown <= 0) {
          clearInterval(interval);
          resetScreen();
        }
      }, 1000);
    };

    ipcRenderer.on("guest-entry", handleGuestEntry);

    // Handle show HID bindings modal
    const handleShowHIDBindings = () => {
      showHIDBindings();
    };

    ipcRenderer.on("show-hid-bindings", handleShowHIDBindings);

    // Handle error (e.g., misswipe)
    const handleEntryError = (event, errorMessage) => {
      showError(errorMessage);
    };

    ipcRenderer.on("entry-error", handleEntryError);

    // HID Bindings Modal Functions
    function showHIDBindings() {
      const modal = document.getElementById('hid-bindings-modal');
      modal.style.display = 'block';

      showLoading();
      try {
        // Load saved devices if they exist
        const savedMSR = configManager.getSelectedDevice('msr');
        const savedBarcode = configManager.getSelectedDevice('barcode');

        // Populate device lists
        const devices = HIDManager.getDevices();
        const msrSelect = document.getElementById('msrSelect');
        const barcodeSelect = document.getElementById('barcodeSelect');

        // Clear existing options except the first one
        while (msrSelect.options.length > 1) msrSelect.remove(1);
        while (barcodeSelect.options.length > 1) barcodeSelect.remove(1);

        // Track if saved devices are found
        let msrFound = false;
        let barcodeFound = false;

        devices.forEach(device => {
          const option = document.createElement('option');
          option.value = device.path;
          option.textContent = device.manufacturer ? `${device.manufacturer} - ${device.product}` : device.product;

          if (savedMSR && device.path === savedMSR) {
            msrFound = true;
          }
          if (savedBarcode && device.path === savedBarcode) {
            barcodeFound = true;
          }

          if (device.product.includes('MSR') || device.product.includes('Swipe')) {
            msrSelect.appendChild(option.cloneNode(true));
          } else {
            barcodeSelect.appendChild(option);
          }
        });

        // Set selected values
        if (msrFound) {
          msrSelect.value = savedMSR;
        } else if (savedMSR) {
          const option = document.createElement('option');
          option.value = savedMSR;
          option.textContent = '[Unavailable] Previously selected device';
          option.disabled = true;
          msrSelect.appendChild(option);
          msrSelect.value = savedMSR;
        }

        if (barcodeFound) {
          barcodeSelect.value = savedBarcode;
        } else if (savedBarcode) {
          const option = document.createElement('option');
          option.value = savedBarcode;
          option.textContent = '[Unavailable] Previously selected device';
          option.disabled = true;
          barcodeSelect.appendChild(option);
          barcodeSelect.value = savedBarcode;
        }
      } catch (error) {
        console.error('Error loading HID devices:', error);
        showError('Failed to load HID devices');
      } finally {
        hideLoading();
      }
    }

    function hideHIDBindings() {
      document.getElementById('hid-bindings-modal').style.display = 'none';
    }

    // Event Listeners for HID Bindings
    const handleSubmitHID = () => {
      const msrDevice = document.getElementById('msrSelect').value;
      const barcodeDevice = document.getElementById('barcodeSelect').value;

      showLoading();
      ipcRenderer.send('save-device', {
        msr: msrDevice,
        barcode: barcodeDevice
      });
      hideHIDBindings();
    };

    document.getElementById('submit-hid').addEventListener('click', handleSubmitHID);
    document.getElementById('cancel-hid').addEventListener('click', hideHIDBindings);

    // Close modal when clicking outside
    const handleModalClick = (event) => {
      const modal = document.getElementById('hid-bindings-modal');
      if (event.target === modal) {
        hideHIDBindings();
      }
    };

    window.addEventListener('click', handleModalClick);
  </script>
</body>

</html>